(()=>{"use strict";(()=>{const e=(e,t,o)=>(e.responseType="json",e.addEventListener("load",(()=>{200===e.status?t(e.response):o("Статус ответа: "+e.status+" "+e.statusText)})),e.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+e.timeout+"мс")})),e.timeout=1e4,e);window.ajax={download:(t,o)=>{const r=new XMLHttpRequest;e(r,t,o),r.open("GET","https://21.javascript.pages.academy/keksobooking/data"),r.send()},upload:(t,o,r)=>{const n=new XMLHttpRequest;e(n,o,r),n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(t)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=["gif","jpg","jpeg","png"],t={width:"70px",height:"70px",class:"preview__image",position:"absolute",left:"0"},o={position:"relative"},r=document.querySelector(".ad-form-header__preview"),n=document.querySelector('.ad-form__field input[type="file"]'),a=document.querySelector(".ad-form__photo"),d=document.querySelector('.ad-form__upload input[type="file"]'),c=(r,n)=>()=>{const a=r.files[0],d=a.name.toLowerCase();if(e.some((e=>d.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{const r=((e,r)=>{const n=document.createElement("img");return n.setAttribute("width",t.width),n.setAttribute("height",t.height),n.setAttribute("class",t.class),n.style.position=t.position,n.style.left=t.left,n.src=r.result,e.style.position=o.position,n})(n,e);n.appendChild(r)})),e.readAsDataURL(a)}};n.addEventListener("change",c(n,r)),d.addEventListener("change",c(d,a)),window.preview={imageDeleter:()=>{const e=r.querySelector(".preview__image"),t=a.querySelector(".preview__image");e&&e.remove(),t&&t.remove()}}})(),(()=>{const e={1:[1],2:[1,2],3:[1,2,3],100:[0]},t={bungalow:0,flat:1e3,house:5e3,palace:1e4},o=document.querySelector(".ad-form"),r=o.querySelectorAll("fieldset"),n=o.querySelector("#room_number"),a=o.querySelector("#capacity").querySelectorAll("option"),d=o.querySelector("#type"),c=o.querySelector("#price"),s=o.querySelector("#timein"),i=o.querySelector("#timeout"),l=t=>{a.forEach((e=>{e.disabled=!0})),e[t].forEach((e=>{a.forEach((t=>{Number(t.value)===e&&(t.disabled=!1,t.selected=!0)}))}))};n.addEventListener("change",(e=>{l(e.target.value)}));const u=o.querySelector("#title");u.addEventListener("input",(()=>{u.reportValidity()})),d.addEventListener("change",(e=>{var o;o=e.target.value,c.setAttribute("min",t[o]),c.setAttribute("placeholder",t[o])})),c.addEventListener("input",(()=>{c.reportValidity()}));const p=e=>{s.value=e.target.value,i.value=e.target.value};s.addEventListener("change",(e=>{p(e)})),i.addEventListener("change",(e=>{p(e)}));const m=()=>{window.message.successHandler(),window.page.disable()},f=()=>{o.reportValidity(),window.message.errorHandler()};o.addEventListener("submit",(e=>{e.preventDefault(),window.ajax.upload(new FormData(o),m,f)})),window.form={roomsChecker:l,reset:()=>{o.reset(),window.preview.imageDeleter()},enable:()=>{o.disabled=!0,window.page.toggleFields(r,!1),o.classList.remove("ad-form--disabled")},disable:()=>{o.classList.add("ad-form--disabled"),window.page.toggleFields(r,!0)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=o=>{const r=document.createDocumentFragment();o.slice(0,5).forEach((t=>{r.appendChild((t=>{const o=e.cloneNode(!0),r=t.location.x-e.offsetWidth,n=t.location.y-e.offsetWidth;o.style=`left: ${r}px; top: ${n}px`;const a=o.querySelector("img");return a.alt=t.offer.description,a.src=t.author.avatar,o.addEventListener("click",(()=>{var e;window.card.renderCard(window.card.create(t)),e=o,document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.classList.remove("map__pin--active")})),e.classList.add("map__pin--active")})),o})(t))})),t.appendChild(r)},r=window.debounce((e=>{n(),window.card.closeHandler(),o(e)})),n=()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))};window.pin={hide:n,render:o,update:r}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map"),o=document.querySelector(".map__filters--container"),r=document.querySelector("#card").content.querySelector(".map__card"),n=()=>{const e=document.querySelector(".map__card");e&&e.remove()},a=e=>{27===e.keyCode&&(n(),document.removeEventListener("keydown",a))},d=()=>{n(),document.removeEventListener("click",d)};window.card={create:t=>{const o=r.cloneNode(!0),n=o.querySelector(".popup__features"),c=o.querySelector(".popup__photos"),s=o.querySelector(".popup__close");return o.querySelector(".popup__title").textContent=t.offer.title,o.querySelector(".popup__text--address").textContent=t.offer.address,o.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",o.querySelector(".popup__type").textContent=e[t.offer.TYPE],o.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`,o.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`,((e,t,o)=>{const r=e.offer.features;t.innerHTML="",r.forEach((e=>{const o=document.createElement("li");o.classList="map__feature map__feature--"+e,t.appendChild(o)}))})(t,n),o.querySelector(".popup__description").textContent=t.offer.description,((e,t)=>{const o=t.querySelector("img");t.innerHTML="",e.offer.photos.forEach((e=>{const r=o.cloneNode();r.src=e,t.appendChild(r)}))})(t,c),o.querySelector(".popup__avatar").src=t.author.avatar,document.addEventListener("keydown",a),s.addEventListener("click",d),o},closeHandler:n,render:e=>{const r=document.querySelector(".map__card");r&&r.remove();const n=e;t.insertBefore(n,o)}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error"),r=()=>{document.querySelector(".success")?document.querySelector(".success").remove():document.querySelector(".error").remove(),document.removeEventListener("click",r)},n=e=>{27===e.keyCode&&(document.querySelector(".success")?document.querySelector(".success").remove():document.querySelector(".error").remove(),document.removeEventListener("keydown",n))};window.message={successHandler:()=>{let o=t.cloneNode(!0);e.insertAdjacentElement("afterBegin",o),document.addEventListener("click",r),document.addEventListener("keydown",n)},errorHandler:()=>{let t=o.cloneNode(!0);e.insertAdjacentElement("afterBegin",t),document.addEventListener("click",r),document.addEventListener("keydown",n)}}})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelectorAll(".map__filter"),r=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),a=t.querySelector("#housing-rooms"),d=t.querySelector("#housing-guests");window.filter={onFormChange:()=>{window.pin.update(window.receivedData.filter((o=>(t=>r.value===e||r.value===t.offer.type)(o)&&(e=>{switch(n.value){case"low":return e.offer.price<1e4;case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"high":return e.offer.price>5e4;default:return!0}})(o)&&(t=>a.value===e||parseInt(a.value,10)===t.offer.rooms)(o)&&(t=>d.value===e||parseInt(d.value,10)===t.offer.guests)(o)&&(e=>{const o=t.querySelectorAll(".map__checkbox:checked");return Array.from(o).every((t=>e.offer.features.includes(t.value)))})(o))).slice(0,5))},enableAll:()=>{window.page.toggleFields(o,!1),t.classList.remove("map__filters--faded")},disableAll:()=>{window.page.toggleFields(o,!0),t.classList.add("map__filters--faded")}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector(".map"),o=document.querySelector(".map__filters"),r=document.querySelector(".map__pin--main"),n=document.querySelector(".ad-form__reset");let a=!1;const d=e=>{0===e.button&&i()},c=e=>{13===e.keyCode&&i()},s=()=>{window.filter.disableAll(),window.form.disable(),t.classList.add("map--faded"),a=!1,window.form.reset(),window.preview.imageDeleter(),window.pin.hide(),(()=>{const t=e.querySelector(".map__pin--main");t.style.left="570px",t.style.top="375px"})(),window.move.setCoords(r),o.removeEventListener("change",window.filter.onFormChange),r.addEventListener("mousedown",d),r.addEventListener("keydown",c)},i=()=>{window.ajax.download((e=>{window.receivedData=e,window.pin.render(e)})),window.filter.enableAll(),window.form.enable(),t.classList.remove("map--faded"),a=!0,window.move.setCoords(r),r.removeEventListener("mousedown",d),r.removeEventListener("keydown",c),o.addEventListener("change",window.filter.onFormChange)};n.addEventListener("click",s),window.page={isActive:a,disable:s,enable:i,toggleFields:(e,t)=>{e.forEach((e=>{e.disabled=!!t}))}}})(),(()=>{const e=1167.5,t=document.querySelector(".map__pin--main"),o=document.querySelector("#address");t.addEventListener("mousedown",(o=>{o.preventDefault();let n={x:o.clientX,y:o.clientY};const a=o=>{o.preventDefault();const a=n.x-o.clientX,d=n.y-o.clientY;n={x:o.clientX,y:o.clientY},t.style.top=t.offsetTop-d+"px",t.style.left=t.offsetLeft-a+"px";let c=((t,o)=>{let r={};return r.x=t<=-32.5?-32.5:t>=e?e:t,r.y=o<=86.5?86.5:o>=586.5?586.5:o,r})(t.offsetLeft,t.offsetTop);t.style.top=c.y+"px",t.style.left=c.x+"px",r(t)},d=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",d)}));const r=e=>{window.page.isActive?o.value=Math.round(e.offsetLeft+65)+", "+Math.round(e.offsetTop+43.5):o.value=Math.round(e.offsetLeft+32.5)+", "+Math.round(e.offsetTop+43.5)};window.move={setCoords:r}})(),window.onload=window.page.disable()})();