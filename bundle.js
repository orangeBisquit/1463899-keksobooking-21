(()=>{"use strict";(()=>{const e=(e,t,o)=>(e.responseType="json",e.addEventListener("load",(()=>{200===e.status?t(e.response):o("Статус ответа: "+e.status+" "+e.statusText)})),e.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+e.timeout+"мс")})),e.timeout=1e4,e);window.ajax={download:(t,o)=>{const r=new XMLHttpRequest;e(r,t,o),r.open("GET","https://21.javascript.pages.academy/keksobooking/data"),r.send()},upload:(t,o,r)=>{const n=new XMLHttpRequest;e(n,o,r),n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(t)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form-header__preview"),o=document.querySelector('.ad-form__field input[type="file"]'),r=document.querySelector(".ad-form__photo"),n=document.querySelector('.ad-form__upload input[type="file"]'),a={width:"70px",height:"70px",class:"preview__image",position:"absolute",left:"0"},s={position:"relative"},d=(t,o)=>()=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{const t=((e,t)=>{const o=document.createElement("img");return o.setAttribute("width",a.width),o.setAttribute("height",a.height),o.setAttribute("class",a.class),o.style.position=a.position,o.style.left=a.left,o.src=t.result,e.style.position=s.position,o})(o,e);o.appendChild(t)})),e.readAsDataURL(r)}};o.addEventListener("change",d(o,t)),n.addEventListener("change",d(n,r)),window.preview={previewImageDeleter:()=>{const e=t.querySelector(".preview__image"),o=r.querySelector(".preview__image");e&&e.remove(),o&&o.remove()}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelectorAll("fieldset"),o=e.querySelector("#room_number"),r=e.querySelector("#capacity").querySelectorAll("option"),n=e.querySelector("#type"),a=e.querySelector("#price"),s=e.querySelector("#timein"),d=e.querySelector("#timeout"),i={1:[1],2:[1,2],3:[1,2,3],100:[0]},c={bungalow:0,flat:1e3,house:5e3,palace:1e4},l=e=>{r.forEach((e=>{e.disabled=!0})),i[e].forEach((e=>{r.forEach((t=>{Number(t.value)===e&&(t.disabled=!1,t.selected=!0)}))}))};o.addEventListener("change",(e=>{l(e.target.value)}));const u=e.querySelector("#title");u.addEventListener("input",(()=>{u.reportValidity()})),n.addEventListener("change",(e=>{var t;t=e.target.value,a.setAttribute("min",c[t]),a.setAttribute("placeholder",c[t])})),a.addEventListener("input",(()=>{a.reportValidity()}));const p=e=>{s.value=e.target.value,d.value=e.target.value};s.addEventListener("change",(e=>{p(e)})),d.addEventListener("change",(e=>{p(e)}));const m=()=>{window.message.successMessageHandler(),window.page.disablePage()},f=()=>{e.reportValidity(),window.message.errorMessageHandler()};e.addEventListener("submit",(t=>{t.preventDefault(),window.ajax.upload(new FormData(e),m,f)})),window.form={roomsChecker:l,adForm:e,resetForm:()=>{e.reset(),window.preview.previewImageDeleter()},enableForm:()=>{e.disabled=!0,window.page.toggleFields(t,!1),e.classList.remove("ad-form--disabled")},disableForm:()=>{e.classList.add("ad-form--disabled"),window.page.toggleFields(t,!0)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=t=>{const o=e.cloneNode(!0),r=t.location.x-e.offsetWidth,n=t.location.y-e.offsetWidth;o.style=`left: ${r}px; top: ${n}px`;const a=o.querySelector("img");return a.alt=t.offer.description,a.src=t.author.avatar,o.addEventListener("click",(()=>{var e;window.card.renderCard(window.card.createCard(t)),e=o,document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.classList.remove("map__pin--active")})),e.classList.add("map__pin--active")})),o},r=e=>{const r=document.createDocumentFragment();e.slice(0,5).forEach((e=>{r.appendChild(o(e))})),t.appendChild(r)},n=window.debounce((e=>{a(),window.card.cardCloseHandler(),r(e)})),a=()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))};window.pin={getPin:o,hidePins:a,renderPins:r,updatePins:n}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__filters--container"),o={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},r=document.querySelector("#card").content.querySelector(".map__card"),n=()=>{const e=document.querySelector(".map__card");e&&e.remove()},a=e=>{27===e.keyCode&&(n(),document.removeEventListener("keydown",a))},s=()=>{n(),document.removeEventListener("click",s)};window.card={createCard:e=>{const t=r.cloneNode(!0),n=t.querySelector(".popup__features"),d=t.querySelector(".popup__photos"),i=t.querySelector(".popup__close");return t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",t.querySelector(".popup__type").textContent=o[e.offer.TYPE],t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,((e,t,o)=>{const r=e.offer.features;t.innerHTML="",r.forEach((e=>{const o=document.createElement("li");o.classList="map__feature map__feature--"+e,t.appendChild(o)}))})(e,n),t.querySelector(".popup__description").textContent=e.offer.description,((e,t)=>{const o=t.querySelector("img");t.innerHTML="",e.offer.photos.forEach((e=>{const r=o.cloneNode();r.src=e,t.appendChild(r)}))})(e,d),t.querySelector(".popup__avatar").src=e.author.avatar,document.addEventListener("keydown",a),i.addEventListener("click",s),t},cardCloseHandler:n,renderCard:o=>{const r=document.querySelector(".map__card");r&&r.remove();const n=o;e.insertBefore(n,t)}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error"),r=()=>{document.querySelector(".success")?document.querySelector(".success").remove():document.querySelector(".error").remove(),document.removeEventListener("click",r)},n=e=>{27===e.keyCode&&(document.querySelector(".success")?document.querySelector(".success").remove():document.querySelector(".error").remove(),document.removeEventListener("keydown",n))};window.message={successMessageHandler:()=>{let o=t.cloneNode(!0);e.insertAdjacentElement("afterBegin",o),document.addEventListener("click",r),document.addEventListener("keydown",n)},errorMessageHandler:()=>{let t=o.cloneNode(!0);e.insertAdjacentElement("afterBegin",t),document.addEventListener("click",r),document.addEventListener("keydown",n)}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelectorAll(".map__filter"),o=e.querySelector("#housing-type"),r=e.querySelector("#housing-price"),n=e.querySelector("#housing-rooms"),a=e.querySelector("#housing-guests"),s="any";window.filter={applyAllFilters:()=>window.receivedData.filter((t=>(e=>o.value===s||o.value===e.offer.type)(t)&&(e=>{switch(r.value){case"low":return e.offer.price<1e4;case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"high":return e.offer.price>5e4;default:return!0}})(t)&&(e=>n.value===s||parseInt(n.value,10)===e.offer.rooms)(t)&&(e=>a.value===s||parseInt(a.value,10)===e.offer.guests)(t)&&(t=>{const o=e.querySelectorAll(".map__checkbox:checked");return Array.from(o).every((e=>t.offer.features.includes(e.value)))})(t))).slice(0,5),onFilterFormChange:()=>{window.pin.updatePins(window.filter.applyAllFilters())},enableFilters:()=>{window.page.toggleFields(t,!1),e.classList.remove("map__filters--faded")},disableFilters:()=>{window.page.toggleFields(t,!0),e.classList.add("map__filters--faded")}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector(".map"),o=document.querySelector(".map__filters"),r=document.querySelector(".map__pin--main"),n=document.querySelector(".ad-form__reset");let a=!1;const s=e=>{0===e.button&&c()},d=e=>{13===e.keyCode&&c()},i=()=>{window.filter.disableFilters(),window.form.disableForm(),t.classList.add("map--faded"),a=!1,window.form.resetForm(),window.preview.previewImageDeleter(),window.pin.hidePins(),(()=>{const t=e.querySelector(".map__pin--main");t.style.left="570px",t.style.top="375px"})(),window.move.setCoords(r),o.removeEventListener("change",window.filter.onFormChange),r.addEventListener("mousedown",s),r.addEventListener("keydown",d)},c=()=>{window.ajax.download((e=>{window.receivedData=e,window.pin.renderPins(e)})),window.filter.enableFilters(),window.form.enableForm(),t.classList.remove("map--faded"),a=!0,window.move.setCoords(r),r.removeEventListener("mousedown",s),r.removeEventListener("keydown",d),o.addEventListener("change",window.filter.onFilterFormChange)};n.addEventListener("click",i),window.page={pageIsActive:a,disablePage:i,enablePage:c,toggleFields:(e,t)=>{e.forEach((e=>{e.disabled=!!t}))}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address"),o=1167.5;e.addEventListener("mousedown",(t=>{t.preventDefault();let n={x:t.clientX,y:t.clientY};const a=t=>{t.preventDefault();const a=n.x-t.clientX,s=n.y-t.clientY;n={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-s+"px",e.style.left=e.offsetLeft-a+"px";let d=((e,t)=>{let r={};return r.x=e<=-32.5?-32.5:e>=o?o:e,r.y=t<=86.5?86.5:t>=586.5?586.5:t,r})(e.offsetLeft,e.offsetTop);e.style.top=d.y+"px",e.style.left=d.x+"px",r(e)},s=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",s)}));const r=e=>{window.page.pageIsActive?t.value=Math.round(e.offsetLeft+65)+", "+Math.round(e.offsetTop+43.5):t.value=Math.round(e.offsetLeft+32.5)+", "+Math.round(e.offsetTop+43.5)};window.move={setCoords:r}})(),window.onload=window.page.disablePage()})();